name: build-and-package

on:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.os }} x64 release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    env:
      DOTNET_PATH: ./vendor/runtime

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./build.ps1

      - name: Build (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          chmod +x ./build.sh
          ./build.sh

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $outDir = "dist"
          New-Item -ItemType Directory -Force $outDir | Out-Null

          $src = "build/windows/x64/release"
          if (-not (Test-Path $src)) { throw "Build output not found: $src" }

          Copy-Item "$src\sw2tracer.dll" $outDir -Force
          if (Test-Path "$src\sw2tracer.lib") { Copy-Item "$src\sw2tracer.lib" $outDir -Force }
          if (Test-Path "$src\sw2tracer.exp") { Copy-Item "$src\sw2tracer.exp" $outDir -Force }

          $zip = "sw2tracer-$env:RUNNER_OS-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$outDir\*" -DestinationPath $zip

      - name: Install zip (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          src="build/linux/x64/release"
          test -d "$src"
          cp "$src/libsw2tracer.so" dist/
          zip="sw2tracer-${RUNNER_OS}-x64.zip"
          rm -f "$zip"
          (cd dist && zip -r "../$zip" .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sw2tracer-${{ runner.os }}-x64
          path: sw2tracer-${{ runner.os }}-x64.zip

      - name: Upload to GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: sw2tracer-${{ runner.os }}-x64.zip


